<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.feng.oldfriend.dao.LyjRequirementMapper">
    <resultMap id="BaseResultMap" type="com.feng.oldfriend.entity.LyjRequirement">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="lyj_requirement_id" jdbcType="INTEGER" property="lyjRequirementId"/>
        <result column="lyj_requirement_name" jdbcType="VARCHAR" property="lyjRequirementName"/>
        <result column="lyj_requirement_description" jdbcType="VARCHAR" property="lyjRequirementDescription"/>
        <result column="lyj_requirement_createuser" jdbcType="VARCHAR" property="lyjRequirementCreateuser"/>
        <result column="lyj_requirement_applyuser" jdbcType="VARCHAR" property="lyjRequirementApplyuser"/>
        <result column="lyj_requirement_isvolunteer" jdbcType="INTEGER" property="lyjRequirementIsvolunteer"/>
        <result column="lyj_requirement_city" jdbcType="VARCHAR" property="lyjRequirementCity"/>
        <result column="lyj_requirement_area" jdbcType="VARCHAR" property="lyjRequirementArea"/>
        <result column="lyj_requirement_street" jdbcType="VARCHAR" property="lyjRequirementStreet"/>
        <result column="lyj_requirement_createdatetime" jdbcType="TIMESTAMP" property="lyjRequirementCreatedatetime"/>
        <result column="lyj_requirement_begindatetime" jdbcType="TIMESTAMP" property="lyjRequirementBegindatetime"/>
        <result column="lyj_requirement_enddatetime" jdbcType="TIMESTAMP" property="lyjRequirementEnddatetime"/>
        <result column="lyj_requirement_rawaddress" jdbcType="VARCHAR" property="lyjRequirementRawaddress"/>
        <result column="lyj_requirement_maplocation" jdbcType="VARCHAR" property="lyjRequirementMaplocation"/>
        <result column="lyj_requirement_reward" jdbcType="INTEGER" property="lyjRequirementReward"/>
        <result column="lyj_requirement_volunteerperfer" jdbcType="INTEGER" property="lyjRequirementVolunteerperfer"/>
        <result column="lyj_requirement_detailadd" jdbcType="VARCHAR" property="lyjRequirementDetailadd"/>
        <result column="lyj_requirement_state" jdbcType="INTEGER" property="lyjRequirementState"/>
        <result column="lyj_requirement_num" jdbcType="INTEGER" property="lyjRequirementNum"/>
        <result column="lyj_requirement_process" jdbcType="INTEGER" property="lyjRequirementProcess"/>
        <result column="lyj_requirement_applyednum" jdbcType="INTEGER" property="lyjRequirementApplyednum"/>
        <result column="lyj_company_name" jdbcType="VARCHAR" property="lyjCompanyName"/>


    </resultMap>

    <sql id="Base_Column_List">
      lyj_requirement.lyj_requirement_id,
      lyj_requirement.lyj_requirement_name,
      lyj_requirement.lyj_requirement_description,
      lyj_requirement.lyj_requirement_createuser,
      lyj_requirement.lyj_requirement_applyuser,
      lyj_requirement.lyj_requirement_isvolunteer,
      lyj_requirement.lyj_requirement_city,
      lyj_requirement.lyj_requirement_area,
      lyj_requirement.lyj_requirement_street,
      lyj_requirement.lyj_requirement_createdatetime,
      lyj_requirement.lyj_requirement_begindatetime,
      lyj_requirement.lyj_requirement_enddatetime,
      lyj_requirement.lyj_requirement_rawaddress,
      lyj_requirement.lyj_requirement_maplocation,
      lyj_requirement.lyj_requirement_reward
      lyj_requirement.lyj_requirement_volunteerperfer,
      lyj_requirement.lyj_requirement_detailadd,
      lyj_requirement.lyjRequirementState,
      lyj_requirement.lyjRequirementNum,
      lyj_requirement.lyjRequirementProcess,
      lyj_requirement.lyjRequirementApplyednum

  </sql>

    <!--子查询 查询所属的类型-->
    <resultMap type="com.feng.oldfriend.entity.LyjRequirementVO" id="RequirementAndType" extends="BaseResultMap">
        <collection column="lyj_requirement_id" property="allTypes"
                    ofType="com.feng.oldfriend.entity.LyjRequirementType"
                    select="getTypesById">
        </collection>
    </resultMap>

    <!--根据需求ID查询到所有的需求类型-->
    <select id="getTypesById" resultType="com.feng.oldfriend.entity.LyjRequirementType">
        SELECT
        t3.lyj_requirement_typeid as lyjRequirementTypeid,
        t3.lyj_requirement_typename as lyjRequirementTypename,
        t3.lyj_requirement_typeparentid as lyjRequirementTypeparentid
        FROM
        lyj_requirement t1
        left join lyj_requirementtype_relation t2 on t1.lyj_requirement_id=t2.lyj_requirement_id
        left join lyj_requirement_type t3 on t3.lyj_requirement_typeid=t2.lyj_requirement_typeid
        where t1.lyj_requirement_id=#{requirenmentId}
    </select>

    <!--根据搜索内容进行查找数据-->
    <select id="getLyjRequirements" resultMap="RequirementAndType">
        <bind name="pattern" value="'%' + searchText + '%'"/>
        SELECT
        b.*
        FROM
        lyj_requirement b
        <where>
            <if test="searchText!=null and searchText!='' ">
                (
                b.lyj_requirement_name like #{pattern}
                or b.lyj_requirement_description like #{pattern}
                or b.lyj_requirement_city like #{pattern}
                or b.lyj_requirement_area like #{pattern}
                or b.lyj_requirement_street like #{pattern}
                or b.lyj_requirement_rawaddress like #{pattern}
                )
            </if>
        </where>
    </select>

    <select id="getLyjRequirementsCount" resultType="java.lang.Integer">
        <bind name="pattern" value="'%' + searchText + '%'"/>
        SELECT
        count(1)
        FROM
        lyj_requirement b
        <where>
            <if test="searchText!=null and searchText!='' ">
                (
                b.lyj_requirement_name like #{pattern}
                or b.lyj_requirement_description like #{pattern}
                or b.lyj_requirement_city like #{pattern}
                or b.lyj_requirement_area like #{pattern}
                or b.lyj_requirement_street like #{pattern}
                or b.lyj_requirement_rawaddress like #{pattern}
                )
            </if>
        </where>
    </select>

    <!--根据搜索内容和需求类型ID进行查找数据-->
    <select id="getLyjRequirementsByTypeId" resultMap="RequirementAndType">
        <bind name="pattern" value="'%' + searchText + '%'"/>
        SELECT
        b.*
        FROM
        lyj_requirementtype_relation a left join
        lyj_requirement b
        on a.lyj_requirement_id=b.lyj_requirement_id
        where a.lyj_requirement_typeid=#{typeId}
        <if test="searchText!=null and searchText!='' ">
            (
            a.lyj_requirement_name like #{pattern}
            or a.lyj_requirement_description like #{pattern}
            or a.lyj_requirement_city like #{pattern}
            or a.lyj_requirement_area like #{pattern}
            or a.lyj_requirement_street like #{pattern}
            or a.lyj_requirement_rawaddress like #{pattern}
            )
        </if>
    </select>

    <select id="getLyjRequirementsByTypeIdCount" resultType="java.lang.Integer">
        <bind name="pattern" value="'%' + searchText + '%'"/>
        SELECT
        count(1)
        FROM
        lyj_requirementtype_relation a left join
        lyj_requirement b
        on a.lyj_requirement_id=b.lyj_requirement_id
        where a.lyj_requirement_typeid=#{typeId}
        <if test="searchText!=null and searchText!='' ">
            (
            a.lyj_requirement_name like #{pattern}
            or a.lyj_requirement_description like #{pattern}
            or a.lyj_requirement_city like #{pattern}
            or a.lyj_requirement_area like #{pattern}
            or a.lyj_requirement_street like #{pattern}
            or a.lyj_requirement_rawaddress like #{pattern}
            )
        </if>
    </select>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from lyj_requirement
        where lyj_requirement_id = #{lyjRequirementId,jdbcType=INTEGER}
    </delete>
    <insert id="insert" useGeneratedKeys="true" keyProperty="lyjRequirementId" keyColumn="lyj_requirement_id"
            parameterType="com.feng.oldfriend.entity.LyjRequirement">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into lyj_requirement (lyj_requirement_id, lyj_requirement_name,
        lyj_requirement_description, lyj_requirement_createuser,
        lyj_requirement_applyuser, lyj_requirement_isvolunteer,
        lyj_requirement_city, lyj_requirement_area,
        lyj_requirement_street, lyj_requirement_createdatetime,
        lyj_requirement_begindatetime, lyj_requirement_enddatetime,
        lyj_requirement_rawaddress, lyj_requirement_maplocation,
        lyj_requirement_reward,lyj_requirement_volunteerperfer,
        lyj_requirement_detailadd,lyj_requirement_state,lyj_requirement_num,lyj_requirement_process,lyj_requirement_applyednum)
        values (#{lyjRequirementId,jdbcType=INTEGER}, #{lyjRequirementName,jdbcType=VARCHAR},
        #{lyjRequirementDescription,jdbcType=VARCHAR}, #{lyjRequirementCreateuser,jdbcType=VARCHAR},
        #{lyjRequirementApplyuser,jdbcType=VARCHAR}, #{lyjRequirementIsvolunteer,jdbcType=INTEGER},
        #{lyjRequirementCity,jdbcType=VARCHAR}, #{lyjRequirementArea,jdbcType=VARCHAR},
        #{lyjRequirementStreet,jdbcType=VARCHAR}, #{lyjRequirementCreatedatetime,jdbcType=TIMESTAMP},
        #{lyjRequirementBegindatetime,jdbcType=TIMESTAMP}, #{lyjRequirementEnddatetime,jdbcType=TIMESTAMP},
        #{lyjRequirementRawaddress,jdbcType=VARCHAR}, #{lyjRequirementMaplocation,jdbcType=VARCHAR},
        #{lyjRequirementReward,jdbcType=INTEGER},#{lyjRequirementVolunteerperfer,jdbcType=INTEGER},
        #{lyjRequirementDetailadd,jdbcType=VARCHAR},#{lyjRequirementState,jdbcType=INTEGER},#{lyjRequirementNum,jdbcType=INTEGER},
        #{lyjRequirementProcess,jdbcType=INTEGER},#{lyjRequirementApplyednum,jdbcType=INTEGER})

    </insert>

    <insert id="insertAdvanced" useGeneratedKeys="true" keyProperty="lyjRequirementId" keyColumn="lyj_requirement_id"
            parameterType="com.feng.oldfriend.entity.LyjRequirement">
        insert into lyj_requirement (lyj_requirement_id, lyj_requirement_name,
        lyj_requirement_description, lyj_requirement_createuser,
        lyj_requirement_applyuser, lyj_requirement_isvolunteer,
        lyj_requirement_city, lyj_requirement_area,
        lyj_requirement_street, lyj_requirement_createdatetime,
        lyj_requirement_begindatetime, lyj_requirement_enddatetime,
        lyj_requirement_rawaddress, lyj_requirement_maplocation,
        lyj_requirement_reward,lyj_requirement_volunteerperfer,
        lyj_requirement_detailadd,lyj_requirement_state,lyj_requirement_num,lyj_requirement_process,lyj_requirement_applyednum)

        values (#{lyjRequirementId,jdbcType=INTEGER}, #{lyjRequirementName,jdbcType=VARCHAR},
        #{lyjRequirementDescription,jdbcType=VARCHAR}, #{lyjRequirementCreateuser,jdbcType=VARCHAR},
        #{lyjRequirementApplyuser,jdbcType=VARCHAR}, #{lyjRequirementIsvolunteer,jdbcType=INTEGER},
        #{lyjRequirementCity,jdbcType=VARCHAR}, #{lyjRequirementArea,jdbcType=VARCHAR},
        #{lyjRequirementStreet,jdbcType=VARCHAR}, #{lyjRequirementCreatedatetime,jdbcType=TIMESTAMP},
        #{lyjRequirementBegindatetime,jdbcType=TIMESTAMP}, #{lyjRequirementEnddatetime,jdbcType=TIMESTAMP},
        #{lyjRequirementRawaddress,jdbcType=VARCHAR}, #{lyjRequirementMaplocation,jdbcType=VARCHAR},
        #{lyjRequirementReward,jdbcType=INTEGER},#{lyjRequirementVolunteerperfer,jdbcType=INTEGER},
        #{lyjRequirementDetailadd,jdbcType=VARCHAR},#{lyjRequirementState,jdbcType=INTEGER},#{lyjRequirementNum,jdbcType=INTEGER},
        #{lyjRequirementProcess,jdbcType=INTEGER},#{lyjRequirementApplyednum,jdbcType=INTEGER})
    </insert>

    <update id="updateByPrimaryKey">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update lyj_requirement
        set lyj_requirement_name = #{lyjRequirementName,jdbcType=VARCHAR},
        lyj_requirement_description = #{lyjRequirementDescription,jdbcType=VARCHAR},
        lyj_requirement_createuser = #{lyjRequirementCreateuser,jdbcType=VARCHAR},
        lyj_requirement_applyuser = #{lyjRequirementApplyuser,jdbcType=VARCHAR},
        lyj_requirement_isvolunteer = #{lyjRequirementIsvolunteer,jdbcType=INTEGER},
        lyj_requirement_city = #{lyjRequirementCity,jdbcType=VARCHAR},
        lyj_requirement_area = #{lyjRequirementArea,jdbcType=VARCHAR},
        lyj_requirement_street = #{lyjRequirementStreet,jdbcType=VARCHAR},
        lyj_requirement_createdatetime = #{lyjRequirementCreatedatetime,jdbcType=TIMESTAMP},
        lyj_requirement_begindatetime = #{lyjRequirementBegindatetime,jdbcType=TIMESTAMP},
        lyj_requirement_enddatetime = #{lyjRequirementEnddatetime,jdbcType=TIMESTAMP},
        lyj_requirement_rawaddress = #{lyjRequirementRawaddress,jdbcType=VARCHAR},
        lyj_requirement_maplocation = #{lyjRequirementMaplocation,jdbcType=VARCHAR},
        lyj_requirement_reward = #{lyjRequirementReward,jdbcType=INTEGER},
        lyj_requirement_volunteerperfer=#{lyjRequirementVolunteerperfer,jdbcType=INTEGER},
        lyj_requirement_detailadd=#{lyjRequirementDetailadd,jdbcType=VARCHAR},
        lyj_requirement_state=#{lyjRequirementState,jdbcType=INTEGER},
        lyj_requirement_num=#{lyjRequirementNum,jdbcType=INTEGER},
        lyj_requirement_process=#{lyjRequirementProcess,jdbcType=INTEGER},
        lyj_requirement_applyednum=#{lyjRequirementApplyednum,jdbcType=INTEGER}

        where lyj_requirement_id = #{lyjRequirementId,jdbcType=INTEGER}
    </update>

    <update id="updateByPrimaryKeyNormal">
        update lyj_requirement
        set lyj_requirement_name = #{lyjRequirementName,jdbcType=VARCHAR},
        lyj_requirement_description = #{lyjRequirementDescription,jdbcType=VARCHAR},
        lyj_requirement_createuser = #{lyjRequirementCreateuser,jdbcType=VARCHAR},
        lyj_requirement_applyuser = #{lyjRequirementApplyuser,jdbcType=VARCHAR},
        lyj_requirement_isvolunteer = #{lyjRequirementIsvolunteer,jdbcType=INTEGER},
        lyj_requirement_city = #{lyjRequirementCity,jdbcType=VARCHAR},
        lyj_requirement_area = #{lyjRequirementArea,jdbcType=VARCHAR},
        lyj_requirement_street = #{lyjRequirementStreet,jdbcType=VARCHAR},
        lyj_requirement_createdatetime = #{lyjRequirementCreatedatetime,jdbcType=TIMESTAMP},
        lyj_requirement_begindatetime = #{lyjRequirementBegindatetime,jdbcType=TIMESTAMP},
        lyj_requirement_enddatetime = #{lyjRequirementEnddatetime,jdbcType=TIMESTAMP},
        lyj_requirement_rawaddress = #{lyjRequirementRawaddress,jdbcType=VARCHAR},
        lyj_requirement_maplocation = #{lyjRequirementMaplocation,jdbcType=VARCHAR},
        lyj_requirement_reward = #{lyjRequirementReward,jdbcType=INTEGER},
        lyj_requirement_volunteerperfer=#{lyjRequirementVolunteerperfer,jdbcType=INTEGER},
        lyj_requirement_detailadd=#{lyjRequirementDetailadd,jdbcType=VARCHAR},
        lyj_requirement_state=#{lyjRequirementState,jdbcType=INTEGER},
        lyj_requirement_num=#{lyjRequirementNum,jdbcType=INTEGER},
        lyj_requirement_process=#{lyjRequirementProcess,jdbcType=INTEGER},
        lyj_requirement_applyednum=#{lyjRequirementApplyednum,jdbcType=INTEGER}

        where lyj_requirement_id = #{lyjRequirementId,jdbcType=INTEGER}
    </update>

    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select lyj_requirement_id, lyj_requirement_name, lyj_requirement_description, lyj_requirement_createuser,
        lyj_requirement_applyuser, lyj_requirement_isvolunteer, lyj_requirement_city, lyj_requirement_area,
        lyj_requirement_street, lyj_requirement_createdatetime, lyj_requirement_begindatetime,
        lyj_requirement_enddatetime, lyj_requirement_rawaddress, lyj_requirement_maplocation,
        lyj_requirement_reward,lyj_requirement_volunteerperfer,lyj_requirement_detailadd,lyj_requirement_state,lyj_requirement_num,lyj_requirement_process,
        lyj_requirement_applyednum
        from lyj_requirement
        where lyj_requirement_id = #{lyjRequirementId,jdbcType=INTEGER}

    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select lyj_requirement_id, lyj_requirement_name, lyj_requirement_description, lyj_requirement_createuser,
        lyj_requirement_applyuser, lyj_requirement_isvolunteer, lyj_requirement_city, lyj_requirement_area,
        lyj_requirement_street, lyj_requirement_createdatetime, lyj_requirement_begindatetime,
        lyj_requirement_enddatetime, lyj_requirement_rawaddress, lyj_requirement_maplocation,
        lyj_requirement_reward,lyj_requirement_volunteerperfer,lyj_requirement_detailadd,lyj_requirement_state,lyjRequirementNum,lyj_requirement_process,
        lyj_requirement_applyednum
        from lyj_requirement
    </select>

    <select id="getMyRequirement" resultMap="BaseResultMap">
        select *
        from lyj_requirement
        where lyj_requirement_createuser=#{uuid}
    </select>

    <select id="getMyApplyRequirement" resultMap="BaseResultMap">
        select *
        from lyj_requirement
         where lyj_requirement_applyuser=#{uuid}
    </select>

    <!--根据机构进行查找数据-->
    <select id="getRequirementsByCompany" resultMap="BaseResultMap">
        <choose>
            <when test="searchText">
                <bind name="pattern" value="'%'+ searchText+'%'"/>
            </when>
            <otherwise>
                <bind name="pattern" value="'%%'"/>
            </otherwise>
        </choose>
        SELECT
        a.*,
        c.lyj_company_name
        FROM
        lyj_companyrequirement_relation b
        left join lyj_requirement a on a.lyj_requirement_id=b.lyj_cr_relation_requirementid
        left join lyj_company c on c.lyj_company_id=b.lyj_cr_relation_companyid
        where 1=1
        <if test="state!=null and state!=0 ">
            and a.lyj_requirement_state=#{state}
        </if>
        <if test="companyId!=null and companyId!=0">
            and b.lyj_cr_relation_companyid=#{companyId}
        </if>
        <if test="searchText!=null and searchText!='' ">
            and
            (
            a.lyj_requirement_name like #{pattern}
            or a.lyj_requirement_description like #{pattern}
            or a.lyj_requirement_city like #{pattern}
            or a.lyj_requirement_area like #{pattern}
            or a.lyj_requirement_street like #{pattern}
            or a.lyj_requirement_rawaddress like #{pattern}
            )
        </if>
    </select>

    <!--根据机构进行查找数据-->
    <select id="getRequirementsByCompanyCount" resultType="java.lang.Integer">
        <choose>
            <when test="searchText">
                <bind name="pattern" value="'%'+ searchText+'%'"/>
            </when>
            <otherwise>
                <bind name="pattern" value="'%%'"/>
            </otherwise>
        </choose>
        SELECT
        count(1)
        FROM
        lyj_companyrequirement_relation b left join
        lyj_requirement a on a.lyj_requirement_id=b.lyj_cr_relation_requirementid
        where 1=1
        <if test="state!=null and state!=0 ">
            and a.lyj_requirement_state=#{state}
        </if>
        <if test="companyId!=null and companyId!=0">
            and b.lyj_cr_relation_companyid=#{companyId}
        </if>
        <if test="searchText!=null and searchText!='' ">
            and
            (
            a.lyj_requirement_name like #{pattern}
            or a.lyj_requirement_description like #{pattern}
            or a.lyj_requirement_city like #{pattern}
            or a.lyj_requirement_area like #{pattern}
            or a.lyj_requirement_street like #{pattern}
            or a.lyj_requirement_rawaddress like #{pattern}
            )
        </if>
    </select>

    <!--批量更新需求的审批状态-->
    <update id="batchUpdateRequirementState">
        update lyj_requirement
        set lyj_requirement_state=#{state}
        <if test="state==3">
            ,lyj_requirement_process=2
        </if>
        where lyj_requirement_id in
        <foreach collection="ids" item="single" index="index"
                 open=" (" close=")" separator=",">
            #{single}
        </foreach>
    </update>

    <!--批量更新需求的审批状态-->
    <update id="batchUpdateRequirementProcess">
        update lyj_requirement
        set lyj_requirement_process=#{state}
        where lyj_requirement_id in
        <foreach collection="ids" item="single" index="index"
                 open=" (" close=")" separator=",">
            #{single}
        </foreach>
    </update>
</mapper>
